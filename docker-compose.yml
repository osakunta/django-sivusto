version: '3'

services:
    production:
        container_name: django-production
        restart: always
        environment:
            DJANGO_PRODUCTION: 1
            DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
            DJANGO_DB_PASSWORD: ${DJANGO_DB_PASSWORD}
        build:
            context: .
            dockerfile: ./Dockerfile
        command: ./bin/production.sh
        ports:
            - "8010:8010"
        links:
            - postgres:postgres
        volumes:
            - /var/log/gunicorn:/var/log/gunicorn
            - /var/django/static:/usr/src/app/static
            - /app/django/media:/usr/src/app/media
            - /app/django/smedia/filer_private:/usr/src/app/smedia/filer_private
            - /app/django/smedia/filer_private_thumbnails:/usr/src/app/smedia/filer_private_thumbnails
            - /saappala/shares/gallery:/usr/src/gallery-images:ro

    test:
        restart: always
        build:
            context: .
            dockerfile: ./Dockerfile
        command: ./bin/development.sh
        ports:
            - "8011:8010"

    postgres:
        container_name: django-postgres
        restart: always
        image: postgres:10-alpine
        environment:
            POSTGRES_USER: django # Also the name of the db
            POSTGRES_PASSWORD: ${DJANGO_DB_PASSWORD}
        ports:
            - "5432:5432"
        volumes:
            - /app/docker/db/django:/var/lib/postgresql/data/
